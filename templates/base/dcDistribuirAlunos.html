<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Distribuição de Alunos - Escola Esmonserrate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/fct/templates/base/css/estilos.css" />
  </head>

  <body>
    <div menu="/fct/templates/base/menuTopo.html"></div>

    <header></header>

    <main>
      <h1>Distribuição de Alunos</h1>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Turma</th>
            <th>Aluno</th>
            <th>Empresa</th>
            <th>Professor Ac.</th>
          </tr>
        </thead>

        <tbody id="tabelaDistribuicao">
          <tr>
            <td>Aluno 1</td>

            <td>
              <select class="form-select mt-3">
                <option>Empresa 1</option>
                <option>Empresa 2</option>
                <option>Empresa 3</option>
                <option>Empresa 4</option>
              </select>
            </td>
          </tr>

          <tr>
            <td>Aluno 2</td>

            <td>
              <select class="form-select mt-3">
                <option>Empresa 1</option>
                <option>Empresa 2</option>
                <option>Empresa 3</option>
                <option>Empresa 4</option>
              </select>
            </td>
          </tr>

          <tr>
            <td>
              <select class="form-select mt-3">
                <option>Aluno 1</option>
                <option>Aluno 2</option>
                <option>Aluno 3</option>
                <option>Aluno 4</option>
              </select>
            </td>

            <td>
              <select class="form-select mt-3">
                <option>Empresa 1</option>
                <option>Empresa 2</option>
                <option>Empresa 3</option>
                <option>Empresa 4</option>
              </select>
            </td>
          </tr>

          <tr>
            <td>
              <select class="form-select mt-3">
                <option>Aluno 1</option>
                <option>Aluno 2</option>
                <option>Aluno 3</option>
                <option>Aluno 4</option>
              </select>
            </td>

            <td>
              <select class="form-select mt-3">
                <option>Empresa 1</option>
                <option>Empresa 2</option>
                <option>Empresa 3</option>
                <option>Empresa 4</option>
              </select>
            </td>
          </tr>
        </tbody>
      </table>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Estatisticas</th>
            <th>Valor</th>
          </tr>
        </thead>

        <tbody id="tabelaEstatistica">
          <tr>
            <td>Nº de alunos</td>
            <td id="numAlunos"></td>
          </tr>
          <tr>
            <td>Nº de Vagas</td>
            <td id="numVagas"></td>
          </tr>
        </tbody>
      </table>
      <div class="text-center mt-4 d-flex justify-content-center gap-3">
        <button class="btn btn-success btn-lg px-4" onclick="AdicionarMatriculados()">Adicionar Matriculados</button>
        <button class="btn btn-success btn-lg px-4" onclick="distribuirAlunos()">Confirmar Distribuição</button>

        <button class="btn btn-primary btn-lg px-5" onclick="location.href='../dc'">Voltar</button>
      </div>
    </main>

    <div rodape="/fct/templates/base/rodape.html"></div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://turma12r.alunos.esmonserrate.org/fct/js/code/config.js"></script>
  <script src="https://turma12r.alunos.esmonserrate.org/fct/js/code/loginGoogle.js"></script>
  <script src="/fct/js/code/html.js"></script>
    <script>
  includeHTML("rodape");
  includeHTML("menu");
</script>
<script>
    lg = new loginGoogle();
    //lg.renderAutenticaWithTypeAdmin();
    lg.renderAutenticaURLS();
  </script>
    <script>
      // exemple of fetch using POST
      const AdicionarMatriculados = async () => {
        try {
          const response = await fetch("https://turma12r.alunos.esmonserrate.org/fct/public/api/estagiarios/add-matriculas", {
            method: "POST", // Método HTTP
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer your-token", // if necessary
            },
            //body: JSON.stringify(dataSend), // Convert data to JSON
          });

          if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
          }

          const dadosResposta = await response.json();
          console.log("Data updated:", dadosResposta);
          alert("Matriculados adicionados com sucesso!");
        } catch (erro) {
          console.error("Error updating data:", erro);
        }
      };
    </script>

    <script>
      //Asyncronous function (wait for the endPoint api anwser)
      const vagas = async () => {
        let strHtml = `<select class="form-select mt-3 emp" id="|naoescolhido|">
                        <option value="1">Escolha uma empresa</option>`;
        let totalEmpresas=0
        const response = await fetch("https://turma12r.alunos.esmonserrate.org/fct/public/api/estagiarios/vagas/5");
        const dataArray = await response.json();
        for (const dataRecord of dataArray) {
          for(var i=1; i<=dataRecord.NumVagas;i++){
            totalEmpresas++;
            strHtml += `<option value="${dataRecord.NIF}">${dataRecord.NomeEmpresa}</option>`;
          }
          
        }
        strHtml += `</select>`;
        document.getElementById("numVagas").innerHTML = totalEmpresas;
        return strHtml;
      };

      //Asyncronous function (wait for the endPoint api anwser)
      const professores = async () => {
        let strHtml = `<select class="form-select mt-3" id="|naoescolhido|">
                        <option value="1">professor não definido</option>`;
        const response = await fetch("https://turma12r.alunos.esmonserrate.org/fct/public/api/professores/curso/5");
        const dataArray = await response.json();
        for (const dataRecord of dataArray) {
            strHtml += `<option value="${dataRecord.processo}">${dataRecord.Nome}</option>`;          
        }
        strHtml += `</select>`;
        return strHtml;
      };


      //let listEmpresas=await vagas()

      //Asyncronous function (wait for the endPoint api anwser)
      const readAPI = async (listEmpresas,listProfs) => {
        let strHtml = ``;
        let a;
        let b;
        let totalAlunos=0
        const response = await fetch("https://turma12r.alunos.esmonserrate.org/fct/public/api/estagiarios/ano-letivo-ativo/5");
        const dataArray = await response.json();
        for (const dataRecord of dataArray) {
          totalAlunos++;
          a=listEmpresas
          a=a.replace("|naoescolhido|", "emp" + dataRecord.ID)
          b=listProfs
          b=b.replace("|naoescolhido|", "prof" + dataRecord.ID)
          strHtml += `
                <tr>
                    <td>${dataRecord.NomeTurma}</td>
                    <td>${dataRecord.Nome}</td>
                    <td>${a}</td>
                    <td>${b}</td>
                </tr>
                   `;
        }
        document.getElementById("tabelaDistribuicao").innerHTML = strHtml;
        document.getElementById("numAlunos").innerHTML = totalAlunos;
        for (const dataRecord of dataArray) {
          document.getElementById("emp"+ dataRecord.ID ).value=dataRecord.NIF
          document.getElementById("prof"+ dataRecord.ID ).value=dataRecord.ProcessoProf
        }
      };
      // function call
      //readAPI();


      const initialize = async () => {
          let listEmpresas = await vagas();
          let listProfs = await professores();
          await readAPI(listEmpresas,listProfs);
      }

      function distribuirAlunos(){
        document.querySelectorAll('.emp').forEach(element => {
          const id = element.id.replace('emp', '');
          updateData(id);
        });
      }

      // exemple of fetch using PUT
      const updateData = async (id) => {
        try {
          // The data to send
          const dataSend= {
            NIF: document.getElementById("emp"+id).value,
            ProcessoProf: document.getElementById("prof"+id).value,
            ID: id,
          };

          //console.log(JSON.stringify(dataSend));
          //console.log(dataSend)
          const response = await fetch("https://turma12r.alunos.esmonserrate.org/fct/public/api/estagiarios", {
            method: "PUT", // Método HTTP
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer your-token", // if necessary
            },
            body: JSON.stringify(dataSend), // Convert data to JSON
          });

          //console.log(JSON.stringify(dataSend))
          if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
          }

          const dadosResposta = await response.json();
          console.log("Data updated:", dadosResposta);
        } catch (erro) {
          console.error("Error updating data:", erro);
        }
      };


      initialize();
    </script>
  </body>
</html>
