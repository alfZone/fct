<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Distribuição de Alunos - Escola Esmonserrate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet" />
<link rel="stylesheet" href="/fct/templates/base/css/estilos.css" />
  </head>

  <body>
    <div menu="/fct/templates/base/menuTopo.html"></div>

    <header></header>

    <main>
      
      <h1>Documentos</h1>
      <form action="https://turma12r.alunos.esmonserrate.org/fct/public/pdf/cadernetav1" method="post">
      <div class="container">
        <div class="row">
          <div class="col-md-8"></div>
          <div class="col-md-4">
            <button id="fechar" class="btn btn-danger" onclick="window.location.href='../admin/in'">Fechar</button>
            <input id="imprimir" type="submit" class="btn btn-danger" value="Imprimir">
          </div>
          <div class="col-md-12">
            <h3>Estagiário</h3>
            <div class="input-group">
              <span class="input-group-text">Estagiário</span>
              <select class="form-select" id="estagiarios" name="estagiarios" onclick="changeDoc(document.getElementById('estagiarios').value)">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
              </select>
            </div>
          </div>
          <div class="col-md-12">
            <h3>Documentos</h3>
            <div class="input-group">
              <span class="input-group-text">@</span>
              <select class="form-select" id="docs" name="docs" onclick="readDoc(document.getElementById('docs').value)">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
              </select>
            </div>
          </div>
          <div class="col-md-12">
            <div class="input-group">
              <span class="input-group-text">msg</span>
              <textarea class="form-control" rows="5" id="msg" name="txt"></textarea>
            </div>
          </div>
        </div>
      </div>
    </form>
    </main>

    <div rodape="/fct/templates/base/rodape.html"></div>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom script -->
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
  <script src="https://turma12r.alunos.esmonserrate.org/fct/js/code/config.js"></script>
  <script src="https://turma12r.alunos.esmonserrate.org/fct/js/code/loginGoogle.js"></script>
  <script src="/fct/js/code/html.js"></script>
  </body>
  <script>
  includeHTML("rodape");
  includeHTML("menu");
</script>
<script>
    lg = new loginGoogle();
    lg.renderAutenticaWithTypeAdmin();
    lg.renderAutenticaURLS();
  </script>

    <script >
      //caixa de mensagens
      $(document).ready(function () {
        $("#msg").summernote();
      });
  </script>
    <script>

      const readEstagiarios = async () => {
        let strHtml = `<option value="0">...Escolha um documento</option>`;
        const response = await fetch("https://turma12r.alunos.esmonserrate.org/fct/public/api/estagiarios/ano-letivo-ativo/5");
        const dataArray = await response.json();
        for (const dataRecord of dataArray) {
          strHtml += `
          <option value="${dataRecord.Processo}">${dataRecord.Nome}</option>
          `;
        }
        document.getElementById("estagiarios").innerHTML = strHtml;
      };

      const readDocs = async () => {
        let strHtml = `<option value="0">...Escolha um documento</option>`;
        const response = await fetch("https://turma12r.alunos.esmonserrate.org/fct/public/api/documentos");
        const dataArray = await response.json();
        for (const dataRecord of dataArray) {
          strHtml += `
          <option value="${dataRecord.ID}">${dataRecord.Nome}</option>
          `;
        }
        document.getElementById("docs").innerHTML = strHtml;
        changeDoc(document.getElementById('estagiarios').value)
      };

      const readDoc = async (id) => {
        //alert("sddsdsfdsfdsfdsfdsf")
        //let strHtml = ``;
        const response = await fetch("https://turma12r.alunos.esmonserrate.org/fct/public/api/documentos/"+id);
        const dataArray = await response.json();
        $("#msg").summernote("code", dataArray[0].Texto);
      };

      const changeDoc = async (processo) => {
    try {
      readDoc(document.getElementById('docs').value)
        const response = await fetch(`https://turma12r.alunos.esmonserrate.org/fct/public/api/estagiarios/ano-letivo-ativo/5/${processo}`);
        const dataArray = await response.json();
        
        if (!dataArray || dataArray.length === 0) return;
        
        //console.log("https://turma12r.alunos.esmonserrate.org/fct/public/api/estagiarios/ano-letivo-ativo/5/${processo}");
        //console.log(dataArray)
        const aluno = dataArray[0];
        const editor = $("#msg");
        let conteudo = editor.summernote("code");
        
        // Função para obter valor de objeto por caminho (ex: "endereco.rua")
        const getValueByPath = (obj, path) => {
            return path.split('.').reduce((current, key) => {
                return current ? current[key] : undefined;
            }, obj);
        };
        
        // Encontrar todos os placeholders
        const regex = /\${@aluno\.([a-zA-Z0-9_.]+)}/g;
        const placeholders = [...conteudo.matchAll(regex)];
        
        // Criar mapa de substituições
        const substituicoes = {};
        
        placeholders.forEach(match => {
            const placeholder = match[0]; // ex: "$@aluno.nome"
            const caminho = match[1];    // ex: "nome" ou "endereco.rua"
            
            if (!substituicoes[placeholder]) {
                const valor = getValueByPath(aluno, caminho);
                if (valor !== undefined && valor !== null) {
                    substituicoes[placeholder] = String(valor);
                } else {
                    substituicoes[placeholder] = `[${caminho} não encontrado]`;
                }
            }
        });
        
        // Aplicar substituições
        Object.entries(substituicoes).forEach(([placeholder, valor]) => {
            const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
            conteudo = conteudo.replace(regex, valor);
        });
        
        // Atualizar editor
        editor.summernote("code", conteudo);
        
        // Log de substituições
        console.log("Substituições realizadas:", substituicoes);
        
        
    } catch (error) {
        console.error("Erro:", error);
        alert("Erro ao carregar dados: " + error.message);
    }
};


      // function call
      readDocs();
      readEstagiarios();
    </script>
    
  </body>
</html>

